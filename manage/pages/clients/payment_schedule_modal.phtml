<?php
// update_installment_modal.phtml
$schedule_config = [
  'mode' => 'normal',
  'per-row' => 'normal',
  'paid_threshold' => '70%',
  'paid_threshold_value' => 70,
  'grace_days' => 5,
  'days_in_month' => 30,
  'interest_defaults' => [2,3,4,5,6],
  'interest_default' => 3
];
?>
<!-- /home/civicbd/civicgroup/manage/pages/clients/update_installment_modal.phtml -->
<div class="modal fade full_screen always" id="updateInstallmentModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-gradient-success text-white border-0 d-flex align-items-center">
        <h5 class="modal-title mb-0">
          <i class="lni lni-dollar me-2"></i>Payment Schedule — <span id="ui_project_name"></span>
        </h5>
        <div class="ms-3">
          <button id="ui_help_btn" type="button" class="btn btn-sm btn-outline-light" title="Help">?</button>
        </div>
        <div class="ms-auto">
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
      </div>

      <div class="modal-body p-4">
        <input type="hidden" id="ui_purchase_id" value="">
        <input type="hidden" id="ui_unsaved_changes" value="0">

        <!-- Summary -->
        <div class="row g-3 mb-4">
          <div class="col-md-2"><div class="card bg-primary text-white h-100"><div class="card-body p-3 text-center"><small class="opacity-75">Total Price</small><div class="h6 mb-0">৳<span id="ui_total_price">0</span></div></div></div></div>
          <div class="col-md-2"><div class="card bg-info text-white h-100"><div class="card-body p-3 text-center"><small class="opacity-75">Booking Money</small><div class="h6 mb-0">৳<span id="ui_booking_money">0</span></div></div></div></div>
          <div class="col-md-2"><div class="card bg-warning text-white h-100"><div class="card-body p-3 text-center"><small class="opacity-75">Down Payment</small><div class="h6 mb-0">৳<span id="ui_down_payment">0</span></div></div></div></div>
          <div class="col-md-2"><div class="card bg-secondary text-white h-100"><div class="card-body p-3 text-center"><small class="opacity-75">Remaining</small><div class="h6 mb-0">৳<span id="ui_remaining">0</span></div></div></div></div>
          <div class="col-md-2"><div class="card bg-light text-dark h-100"><div class="card-body p-3 text-center"><small class="opacity-75">Total Overdue</small><div class="h6 mb-0 text-danger">৳<span id="ui_total_overdue">0</span></div></div></div></div>
          <div class="col-md-2"><div class="card bg-light text-dark h-100"><div class="card-body p-3 text-center"><small class="opacity-75">Total Overpayment</small><div class="h6 mb-0 text-success">৳<span id="ui_total_overpayment">0</span></div></div></div></div>
        </div>

        <!-- Status + change toggle -->
        <div class="row mb-4">
          <div class="col-md-6 d-flex align-items-center gap-3">
            <label class="form-label mb-0 fw-medium">Schedule Status:</label>
            <div class="btn-group" role="group">
              <input type="radio" class="btn-check" name="schedule_status" id="schedule_all" value="all" checked>
              <label class="btn btn-outline-secondary btn-sm" for="schedule_all"><i class="lni lni-list me-1"></i>All</label>
              <input type="radio" class="btn-check" name="schedule_status" id="schedule_unpaid" value="unpaid">
              <label class="btn btn-outline-warning btn-sm" for="schedule_unpaid"><i class="lni lni-time me-1"></i>Unpaid</label>
              <input type="radio" class="btn-check" name="schedule_status" id="schedule_paid" value="paid">
              <label class="btn btn-outline-success btn-sm" for="schedule_paid"><i class="lni lni-checkmark me-1"></i>Paid</label>
            </div>
          </div>
          <div class="col-md-6 text-end">
            <button class="btn btn-outline-secondary btn-sm" id="ui_change_schedule" style="display:none;"><i class="lni lni-edit me-1"></i>Change Schedule</button>
          </div>
        </div>

        <!-- Payment Configuration -->
        <div id="ui_configuration_section" class="card border-0 shadow-sm mb-4">
          <div class="card-header bg-light border-0"><h6 class="mb-0 fw-semibold">Payment Configuration (from booking helper)</h6></div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-3">
                <label class="form-label fw-medium">Mode of Payment</label>
                <select id="ui_mode" class="form-control"><option value="1">Full Payment</option><option value="2">Installment</option></select>
              </div>

              <div id="ui_installment_controls" class="col-md-9">
                <div class="row g-3">
                  <div class="col-md-2"><label class="form-label fw-medium">Installments</label><input type="number" id="ui_installments" class="form-control" min="1" value="60" step="1"></div>
                  <div class="col-md-3"><label class="form-label fw-medium">Adjustment Type</label><select id="ui_adjustment_type" class="form-control"><option value="year_start">Year — Start</option><option value="year_middle">Year — Middle</option><option value="year_end">Year — End</option><option value="year_quarterly">Year — Quaterly</option><option value="custom">Custom (no yearly auto)</option></select></div>
                  <div class="col-md-3"><label class="form-label fw-medium">Monthly Amount <small class="text-muted">(optional)</small></label><input type="number" id="ui_monthly_amount" class="form-control" placeholder="Auto-calc if empty" step="1"></div>
                  <div class="col-md-2"><label class="form-label fw-medium">Yearly Adjustment</label><input type="number" id="ui_yearly_adjustment" class="form-control" placeholder="e.g. 50000" step="1"></div>
                  <div class="col-md-2 d-flex align-items-end"><div class="btn-group w-100" role="group"><button class="btn btn-primary" id="ui_generate_schedule"><i class="lni lni-plus me-1"></i>Generate Schedule</button><button class="btn btn-outline-secondary" id="ui_reset_schedule"><i class="lni lni-refresh me-1"></i>Reset</button></div></div>

                  <div class="col-md-3"><label class="form-label fw-medium">Installment Start Date</label><input type="text" id="ui_start_date" class="form-control" placeholder="dd-mm-yyyy"></div>
                  <div class="col-md-2"><label class="form-label fw-medium">Start Option</label><select id="ui_start_option" class="form-control"><option value="start">Start of month (1st)</option><option value="middle">Middle (15th)</option><option value="end">End of month (last day)</option><option value="exact">Exact (keep chosen day)</option></select></div>
                  <div class="col-md-2"><label class="form-label fw-medium">Interest %</label>
                    <select id="ui_interest_percent" class="form-control">
                      <?php foreach($schedule_config['interest_defaults'] as $opt): ?>
                        <option value="<?php echo intval($opt); ?>" <?php echo (intval($opt) === intval($schedule_config['interest_default'])) ? 'selected' : ''; ?>><?php echo intval($opt); ?>%</option>
                      <?php endforeach; ?>
                    </select>
                    <small class="text-muted d-block">Flat percent applied to overdue amount. Skipped when paid ≥ <?php echo intval($schedule_config['paid_threshold_value']); ?>%.</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Schedule Table -->
        <div class="card border-0 shadow-sm">
          <div class="card-header bg-light border-0 d-flex justify-content-between align-items-center">
            <h6 class="mb-0 fw-semibold">Payment Schedule</h6>
            <div class="btn-group btn-group-sm" role="group">
              <button type="button" class="btn btn-outline-success" id="ui_mark_all_paid"><i class="lni lni-checkmark me-1"></i>Mark All Paid</button>
              <button type="button" class="btn btn-outline-warning" id="ui_mark_all_unpaid"><i class="lni lni-time me-1"></i>Mark All Unpaid</button>
            </div>
          </div>

          <div class="card-body p-0">
            <div class="table-responsive" style="overflow:auto;">
              <table class="table table-hover mb-0" id="ui_schedule_table" style="min-width:1600px">
                <thead class="table-light sticky-top">
                  <tr>
                    <th style="width:45px">#</th>
                    <th style="min-width:160px">Particular</th>
                    <th style="width:120px">Due Date</th>
                    <th style="width:120px">Payment Date</th>
                    <th style="width:140px">Payment Method</th>
                    <th style="width:160px">Installment Amount (৳)</th>
                    <th style="width:140px">Paid Amount (৳)</th>
                    <th style="width:120px">Balance (৳)</th>
                    <th style="width:120px">Over Due (৳)</th>
                    <th style="width:120px">Overpayment (৳)</th>
                    <th style="width:120px">Interest (৳)</th>
                    <th style="width:140px">Money Receipt No</th>
                    <th style="width:220px">Remarks</th>
                    <th style="width:100px">Status</th>
                    <th style="width:120px">Action</th>
                  </tr>
                </thead>

                <tbody></tbody>

                <tfoot class="table-light">
                  <tr class="fw-semibold">
                    <td colspan="5">Total</td>
                    <td>৳<span id="ui_total_amount">0</span></td>
                    <td colspan="9"></td>
                  </tr>
                </tfoot>
              </table>
            </div>

            <!-- Interest summary -->
            <div class="p-3 border-top bg-light d-flex justify-content-between align-items-center">
              <div class="small text-muted">Interest is a flat percent applied to overdue amount. Grace period: <?php echo intval($schedule_config['grace_days']); ?> days. Interest skipped if paid ≥ <?php echo intval($schedule_config['paid_threshold_value']); ?>%.</div>
              <div class="fw-semibold">Total Interest (upto today): ৳<span id="ui_total_interest">0</span></div>
            </div>

            <!-- Totals row with separated columns -->
            <div class="p-3 border-top bg-white d-flex gap-3">
              <div class="flex-grow-1 small text-muted">Column totals:</div>
              <div class="text-end me-3"><div class="small text-muted">Column Overdue</div><div class="fw-semibold text-danger">৳<span id="ui_total_overdue_footer">0</span></div></div>
              <div class="text-end me-3"><div class="small text-muted">Column Overpayment</div><div class="fw-semibold text-success">৳<span id="ui_total_overpayment_footer">0</span></div></div>
              <div class="text-end me-3"><div class="small text-muted">Total Paid</div><div class="fw-semibold">৳<span id="ui_paid_amount_footer">0</span></div></div>
              <div class="text-end"><div class="small text-muted">Remaining after all</div><div class="fw-semibold">৳<span id="ui_remaining_footer">0</span></div></div>
            </div>

          </div>
        </div>

      </div>

      <div class="modal-footer border-0 bg-light d-flex justify-content-between">
        <div class="text-muted small"><strong>Note:</strong> All amounts are integer Taka (৳). Dates normalize to dd-mm-yyyy. Changing Interest % recalculates interest across rows.</div>
        <div class="btn-group" role="group">
          <button id="ui_save_schedule" class="btn btn-success"><i class="lni lni-save me-1"></i>Save Schedule</button>
          <button id="ui_preview_xlsx" class="btn btn-outline-secondary"><i class="lni lni-eye me-1"></i>Preview XLSX</button>
          <button id="ui_close" class="btn btn-secondary" data-bs-dismiss="modal"><i class="lni lni-close me-1"></i>Close</button>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Help Modal -->
<div class="modal fade" id="ui_help_modal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Payment Schedule — How calculations work</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
      <div class="modal-body">
        <p><strong>Summary of calculation rules</strong></p>
        <ul>
          <li><strong>Overdue (per row)</strong> = max(installment_amount - paid_amount, 0). Blank for future unpaid rows.</li>
          <li><strong>Overpayment (per row)</strong> = max(paid_amount - installment_amount, 0).</li>
          <li><strong>Interest</strong> is a flat percentage selected in Payment Configuration (global) and applied to per-row overdue amount. Skipped if paid ≥ <?php echo intval($schedule_config['paid_threshold_value']); ?>%.</li>
          <li><strong>Interest is applied</strong> when raw overdue &gt; 0 AND paid_percent &lt; <?php echo intval($schedule_config['paid_threshold_value']); ?>% (even if payment_date == due_date).</li>
          <li><strong>Future rows</strong> (due date &gt; today) with no paid amount show blank Overdue/Overpayment/Interest/Balance/Remarks — except when they have some paid amount (then calculations show).</li>
          <li><strong>Balance</strong> shows running remaining after that row (blank for future unpaid rows).</li>
          <li><strong>Days in remarks</strong> = days between (payment_date OR due_date) and today minus grace days — informational only.</li>
        </ul>
        <p><strong>Remark templates (short)</strong></p>
        <ol>
          <li>Paid in full</li>
          <li>Partially paid: ৳X of ৳Y</li>
          <li>Overpayment: ৳X applied</li>
          <li>Interest N% on due ৳B (after grace: Nd)</li>
          <li>Interest skipped (≥<?php echo intval($schedule_config['paid_threshold_value']); ?>% paid)</li>
          <li>Booking paid / Down paid</li>
          <li>Yearly Adjustment</li>
          <li>Manual note — ‹text›</li>
          <li>Unpaid</li>
          <li>Payment recorded (future row)</li>
        </ol>
      </div>
      <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button></div>
    </div>
  </div>
</div>

<script>
jQuery(function($){
  'use strict';

  var SCHEDULE_CONFIG = <?php echo json_encode($schedule_config, JSON_HEX_TAG|JSON_HEX_APOS|JSON_HEX_AMP|JSON_HEX_QUOT); ?>;

  /* Utilities */
  function intval(v){ v = Number(v); return isNaN(v) ? 0 : Math.round(v); }
  function fmtMoneyInt(v){ return Math.round(intval(v)).toLocaleString('en-US'); }
  function formatIndianNumber(n){ n = Math.abs(intval(n)); var s = n.toString(); if (s.length <= 3) return s; var last3 = s.slice(-3); var rest = s.slice(0, -3); var res = ''; while (rest.length > 2){ res = ',' + rest.slice(-2) + res; rest = rest.slice(0, -2); } if (rest.length > 0) res = rest + res; return res + ',' + last3; }
  function formatTkDisplay(n, allowZeroDisplay){ if (n === null || n === undefined) return ''; if (n === 0 && !allowZeroDisplay) return ''; var sign = n < 0 ? '-' : ''; return sign + '৳' + formatIndianNumber(n); }
  function digitsOnly(s){ return (s||'').toString().replace(/[^\d]/g,''); }
  function escapeHtml(s){ if (s===undefined || s===null) return ''; return String(s).replace(/[&<"'>]/g,function(m){return{'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#039;"}[m];}); }
  function todayStart(){ const d=new Date(); d.setHours(0,0,0,0); return d; }
  function parseYMD(s){ if (!s) return null; if (typeof s === 'string' && /^\d{2}-\d{2}-\d{4}$/.test(s)){ var parts = s.split('-'); return new Date(parseInt(parts[2],10), parseInt(parts[1],10)-1, parseInt(parts[0],10)); } if (typeof s === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(s)) { var p = s.split('-'); return new Date(parseInt(p[0],10), parseInt(p[1],10)-1, parseInt(p[2],10)); } var d = new Date(s); return isNaN(d.getTime()) ? null : d; }
  function daysBetween(a,b){ if (!a || !b) return 0; const ms = b.getTime() - a.getTime(); return Math.floor(ms / 86400000); }

  function parseDateInputToYMD(s){
    if (!s) return '';
    s = s.trim();
    s = s.replace(/\./g,'-').replace(/\//g,'-');
    if (/^\d{2}-\d{2}-\d{4}$/.test(s)){
      var parts = s.split('-');
      var dd = parseInt(parts[0],10), mm = parseInt(parts[1],10), yy = parseInt(parts[2],10);
      var d = new Date(yy, mm-1, dd);
      if (isNaN(d.getTime())) return '';
      return d.getFullYear() + '-' + ('0' + (d.getMonth()+1)).slice(-2) + '-' + ('0' + d.getDate()).slice(-2);
    }
    if (/^\d{4}-\d{2}-\d{2}$/.test(s)){
      var d = parseYMD(s);
      if (d && !isNaN(d.getTime())) return s;
      return '';
    }
    var tmp = new Date(s);
    if (!isNaN(tmp.getTime())) return tmp.getFullYear() + '-' + ('0' + (tmp.getMonth()+1)).slice(-2) + '-' + ('0' + tmp.getDate()).slice(-2);
    return '';
  }
  function formatDateForInput(ymd){
    if (!ymd) return '';
    var d = parseYMD(ymd);
    if (!d || isNaN(d.getTime())) return '';
    var dd = ('0' + d.getDate()).slice(-2);
    var mm = ('0' + (d.getMonth()+1)).slice(-2);
    return dd + '-' + mm + '-' + d.getFullYear();
  }

  function setUnsaved(flag){ $('#ui_unsaved_changes').val(flag?1:0); }

  // Indian grouping but preserves digit string (leading zeros) for display while typing
  function groupIndianFromDigits(digitsStr){
    if (!digitsStr) return '';
    var s = digitsStr.replace(/^0+/, ''); // we'll re-add leading zeros count below
    var leadingZeros = digitsStr.length - (s.length || 0);
    if (s === '') s = '0';
    var last3 = s.slice(-3);
    var rest = s.slice(0, -3);
    var res = '';
    while (rest.length > 2){ res = ',' + rest.slice(-2) + res; rest = rest.slice(0, -2); }
    if (rest.length > 0) res = rest + res;
    var grouped = res ? res + ',' + last3 : last3;
    // prepend preserved leading zeros visually (as zeros before the first non-zero)
    var leading = '';
    if (leadingZeros > 0){
      // place leading zeros to the leftmost side (may break strict numeric grouping, but preserves typed zeros)
      leading = '0'.repeat(leadingZeros);
      // if grouped is '0' and leadingZeros > 0, avoid duplication of zeros
      if (grouped === '0') grouped = leading;
      else grouped = leading + grouped;
    }
    return grouped;
  }

  function setCaretPositionToDigits($input, digitsBefore, formattedStr){
    var txt = formattedStr || $input.val(); var count = 0; var pos = 0;
    for (var i=0;i<txt.length;i++){ var ch = txt.charAt(i); if (ch >= '0' && ch <= '9') count++; if (count === digitsBefore){ pos = i + 1; break; } }
    if (digitsBefore === 0) pos = (txt.charAt(0) === '৳') ? 1 : 0; if (count < digitsBefore) pos = txt.length;
    try { $input[0].setSelectionRange(pos, pos); } catch(e){}
  }

  /* State */
  var currentPurchaseData = null;
  var currentSchedule = [];
  var originalScheduleConfig = null;
  var installmentColumnEditable = false;
  var GRACE_DAYS = parseInt(SCHEDULE_CONFIG.grace_days || 5, 10);
  var DAYS_IN_MONTH = parseInt(SCHEDULE_CONFIG.days_in_month || 30, 10);
  var PAID_THRESHOLD = parseInt(SCHEDULE_CONFIG.paid_threshold_value || 70, 10);

  /* Change log */
  function recordRowChange(idx, field, oldVal, newVal, reason){
    if (typeof currentSchedule[idx] === 'undefined') return;
    var row = currentSchedule[idx];
    if (!row.history || !Array.isArray(row.history)) row.history = [];
    try {
      var entry = { ts: (new Date()).toISOString(), field: field || '', from: oldVal === undefined ? null : oldVal, to: newVal === undefined ? null : newVal, reason: reason || '' };
      row.history.push(entry);
      if (row.history.length > 200) row.history = row.history.slice(row.history.length - 200);
    } catch(e){}
    setUnsaved(true);
  }

  /* Installment edit toggle */
  function setInstallmentColumnEditable(flag){
    installmentColumnEditable = !!flag;
    $('#ui_schedule_table tbody input[data-field="installment_amount"]').each(function(){
      var $this = $(this);
      var idx = parseInt($this.attr('data-idx'),10);
      var item = currentSchedule[idx];
      if (!installmentColumnEditable && !item.manual_installment_edit) $this.prop('readonly', true).addClass('readonly-input');
      else $this.prop('readonly', false).removeClass('readonly-input');
    });
  }
  function toggleRowInstallmentEditable(idx){
    if (typeof currentSchedule[idx] === 'undefined') return;
    var item = currentSchedule[idx];
    var old = !!item.manual_installment_edit;
    item.manual_installment_edit = !old;
    item.manual_adjustment = true;
    recordRowChange(idx, 'manual_installment_edit', old, item.manual_installment_edit, 'Toggle row installment edit');
    setUnsaved(true);
    updateRowDisplay(idx);
  }

  /* Remarks generator */
  function autoGenerateRemarkForRow(idx){
    var r = currentSchedule[idx]; if (!r) return;
    if (r.manual_remarks) return;

    var inst = intval(r.installment_amount || 0);
    var paid = (r.paid_amount === null || r.paid_amount === undefined) ? 0 : intval(r.paid_amount || 0);
    var paidPct = inst === 0 ? 0 : (paid / inst * 100);

    if (r.adjustment && !r.manual_adjustment){ r.remarks = 'Yearly Adjustment'; return; }

    if (r.type === 'booking' || (typeof r.particular === 'string' && r.particular.toLowerCase().indexOf('booking') !== -1)){
      if (paid >= inst && inst > 0){ r.remarks = 'Booking paid'; } else if (paid > 0) { r.remarks = 'Booking partially paid: ৳' + fmtMoneyInt(paid) + ' of ৳' + fmtMoneyInt(inst); } else { r.remarks = ''; }
      return;
    }
    if (r.type === 'down' || (typeof r.particular === 'string' && r.particular.toLowerCase().indexOf('down') !== -1)){
      if (paid >= inst && inst > 0){ r.remarks = 'Down paid'; } else if (paid > 0) { r.remarks = 'Down partially paid: ৳' + fmtMoneyInt(paid) + ' of ৳' + fmtMoneyInt(inst); } else { r.remarks = ''; }
      return;
    }

    if (paid === inst && inst > 0){ r.remarks = 'Paid in full'; return; }
    if (paid > inst){ r.remarks = 'Overpayment: ৳' + fmtMoneyInt(paid - inst) + ' applied'; return; }
    if (paid > 0 && paid < inst){ r.remarks = 'Partially paid: ৳' + fmtMoneyInt(paid) + ' of ৳' + fmtMoneyInt(inst); return; }

    if (r._future_no_payment){
      r.remarks = '';
      return;
    }

    if (r.interest_amount_calc && r.interest_amount_calc > 0){
      var baseDue = intval(r.installment_amount - (r.paid_amount === null ? 0 : r.paid_amount));
      var p = intval(r.interest_percent || $('#ui_interest_percent').val() || 0);
      var parts = [];
      parts.push('Interest ' + p + '% on due ৳' + formatIndianNumber(baseDue));
      if (r._remark_days_after_grace !== undefined && r._remark_days_after_grace !== null) parts.push('(after grace: ' + r._remark_days_after_grace + 'd)');
      r.remarks = parts.join(' ');
      return;
    }

    r.remarks = '';
  }

  /* Init */
  function initUpdateInstallment(){
    window.openPaymentSchedule = function(purchaseId){ $('#ui_purchase_id').val(purchaseId); loadPurchaseData(purchaseId); $('#updateInstallmentModal').modal('show'); };

    $(document).off('click.updateInstallment', '.update_installment').on('click.updateInstallment', '.update_installment', function(e){ e.preventDefault(); var id = $(this).data('id'); if (id) openPaymentSchedule(id); });

    $('#ui_generate_schedule').off('click').on('click', function(){ generateSchedule(); });
    $('#ui_reset_schedule').off('click').on('click', function(){ if(confirm('Reset schedule?')){ currentSchedule=[]; renderScheduleTable(); recalcTotalDues(); updateTotals(); setUnsaved(true);} });
    $('#ui_mark_all_paid').off('click').on('click', function(){ if(confirm('Mark all as paid?')){ markAllPaid(); }});
    $('#ui_mark_all_unpaid').off('click').on('click', function(){ if(confirm('Mark all as unpaid?')){ markAllUnpaid(); }});

    $('#ui_save_schedule').off('click').on('click', function(){ saveSchedule(); });
    $('#ui_preview_xlsx').off('click').on('click', function(){ previewXlsx(); });
    $('input[name="schedule_status"]').off('change').on('change', function(){ renderScheduleTable(); });

    $('#ui_change_schedule').off('click').on('click', function(){ var vis = $('#ui_configuration_section').is(':visible'); if (vis){ $('#ui_configuration_section').slideUp(); $(this).html('<i class=\"lni lni-edit me-1\"></i>Change Schedule'); } else { $('#ui_configuration_section').slideDown(); $(this).html('<i class=\"lni lni-eye-close me-1\"></i>Hide Configuration'); } });

    $('#ui_toggle_installment_edit').off('click').on('click', function(){ setInstallmentColumnEditable(!installmentColumnEditable); });

    $('#ui_interest_percent').off('change').on('change', function(){ recalcTotalDues(); updateRowsFrom(0); updateTotals(); setUnsaved(true); });

    $('#ui_help_btn').off('click').on('click', function(){ $('#ui_help_modal').modal('show'); });

    $(document).off('keydown.updateInstallment').on('keydown.updateInstallment', function(e){
      if (!$('#updateInstallmentModal').hasClass('show')) return;
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's'){ e.preventDefault(); $('#ui_save_schedule').trigger('click'); }
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'p'){ e.preventDefault(); $('#ui_preview_xlsx').trigger('click'); }
      if (e.key === 'Escape') {
        if ($('#ui_unsaved_changes').val() == '1') {
          if (confirm('You have unsaved changes. Close without saving?')) { $('#updateInstallmentModal').modal('hide'); }
        } else { $('#updateInstallmentModal').modal('hide'); }
      }
    });

    $('#updateInstallmentModal').on('hidden.bs.modal.updateInstallment', function(){ currentPurchaseData = null; currentSchedule = []; originalScheduleConfig = null; setUnsaved(false); });

    try { if (typeof flatpickr === 'function') flatpickr('#ui_start_date', { dateFormat: 'd-m-Y', allowInput: true }); } catch(e){}
  }

  /* Load & normalize */
  function loadPurchaseData(purchaseId){
    $('#ui_project_name').text('Loading...');
    $.get(Wo_Ajax_Requests_File() + '?f=manage_inventory&s=get_purchase_details&purchase_id=' + purchaseId)
      .done(function(resp){
        var data = (typeof resp === 'string') ? (function(){ try { return JSON.parse(resp);} catch(e){ return resp; } })() : resp;
        if (!data || data.status !== 200){ alert('Failed to load purchase data: ' + (data && data.message ? data.message : 'Unknown')); return; }
        currentPurchaseData = data;
        populatePurchaseData(data);
        if (Array.isArray(data.schedule) && data.schedule.length > 0){ currentSchedule = normalizeScheduleFromServer(data.schedule); }
        else { currentSchedule = buildDefaultScheduleFromPurchase(data); }
        loadConfigurationFromPurchase(data);
        recalcTotalDues();
        renderScheduleTable();
        updateTotals();
        $('#ui_change_schedule').show();
      }).fail(function(){ alert('Server error while loading purchase data'); });
  }

  function populatePurchaseData(d){ $('#ui_project_name').text(d.project_name || 'Unknown Project'); $('#ui_total_price').text(fmtMoneyInt(d.total_price || 0)); $('#ui_booking_money').text(fmtMoneyInt(d.booking_money || 0)); $('#ui_down_payment').text(fmtMoneyInt(d.down_payment || 0)); var remaining = intval(d.total_price) - intval(d.down_payment) - intval(d.booking_money); $('#ui_remaining').text(fmtMoneyInt(remaining)); }

  function normalizeScheduleFromServer(schedule){
    return schedule.map(function(s,i){
      var installment_amount = 0, paid_amount = null;
      if (s.installment_amount !== undefined) installment_amount = intval(s.installment_amount);
      else if (s.amount !== undefined) installment_amount = intval(s.amount);
      if (s.paid_amount !== undefined && s.paid_amount !== null) paid_amount = intval(s.paid_amount);
      else if (s.amount_paid !== undefined && s.amount_paid !== null) paid_amount = intval(s.amount_paid);
      else paid_amount = null;

      var servAdj = !!s.adjustment;
      var servRemarks = (s.remarks || '').toString();
      var manual_adjust = !!s.manual_adjustment || (servAdj && servRemarks.toLowerCase() !== 'yearly adjustment' && servRemarks.trim().length > 0);
      var adjFlag = servAdj && !manual_adjust;

      var orig = (s.original_installment_amount !== undefined) ? intval(s.original_installment_amount) : installment_amount;

      return {
        particular: s.particular || s.part || '',
        type: (s.type || '').toString(),
        date: s.date || '',
        payment_date: s.payment_date || '',
        payment_method: s.payment_method || '',
        paid_amount: paid_amount,
        installment_amount: installment_amount,
        original_installment_amount: orig,
        installment: s.installment || (i+1),
        money_receipt_no: s.money_receipt_no || '',
        total_dues: s.total_dues === undefined ? '' : s.total_dues,
        remarks: (s.remarks || (adjFlag ? 'Yearly Adjustment' : '')),
        adjustment: !!adjFlag,
        manual_adjustment: !!manual_adjust,
        manual_installment_edit: !!s.manual_installment_edit,
        manual_remarks: !!s.manual_remarks,
        history: (s.history && Array.isArray(s.history)) ? s.history : [],
        paid: (installment_amount > 0 && paid_amount !== null && paid_amount >= installment_amount) ? true : false,
        interest_percent: s.interest_percent !== undefined ? intval(s.interest_percent) : null,
        interest_amount_calc: s.interest_amount_calc !== undefined ? intval(s.interest_amount_calc) : 0
      };
    });
  }

  function buildDefaultScheduleFromPurchase(d){
    var out = [];
    var booking = intval(d.booking_money); var down = intval(d.down_payment);
    var start = d.installment_start_date || d.booking_due_date || new Date().toISOString().slice(0,10);
    if (booking > 0) out.push({ particular: 'Booking Money', type: 'booking', date: d.booking_due_date || start, payment_date: d.booking_payment_date || '', payment_method: '', paid_amount: null, installment_amount: booking, original_installment_amount: booking, installment: 'Booking', money_receipt_no:'', total_dues: '', remarks: '', adjustment:false, manual_adjustment:false, manual_installment_edit:false, manual_remarks:false, history:[], paid:false, interest_amount_calc:0 });
    if (down > 0) out.push({ particular: 'Down Payment', type: 'down', date: d.down_due_date || start, payment_date: d.down_payment_date || '', payment_method:'', paid_amount: null, installment_amount: down, original_installment_amount: down, installment: 'Down', money_receipt_no:'', total_dues:'', remarks:'', adjustment:false, manual_adjustment:false, manual_installment_edit:false, manual_remarks:false, history:[], paid:false, interest_amount_calc:0 });
    return out;
  }

  function loadConfigurationFromPurchase(d){
    var mode = (d.payment_mode || d.mode_of_payment || d.mode || '2').toString();
    var installments = parseInt(d.installments || d.default_installments || 60,10);
    var adjustment = d.adjustment_type || d.adjustmentType || 'year_end';
    var monthly = intval(d.monthly_amount || d.monthly || 0);
    var yearly = intval(d.yearly_adjustment || d.yearly || 0);
    var start_date = d.installment_start_date || d.default_start_date || new Date().toISOString().slice(0,10);
    var start_option = d.start_option || d.startOption || 'exact';
    var interest_percent = d.interest_percent !== undefined && d.interest_percent !== null ? intval(d.interest_percent) : intval(SCHEDULE_CONFIG.interest_default || 3);

    $('#ui_mode').val(mode);
    $('#ui_installments').val(installments);
    $('#ui_adjustment_type').val(adjustment);
    $('#ui_monthly_amount').val(monthly>0?monthly:'');
    $('#ui_yearly_adjustment').val(yearly>0?yearly:'');
    $('#ui_start_date').val(formatDateForInput(start_date));
    $('#ui_start_option').val(start_option);
    $('#ui_interest_percent').val(interest_percent);

    if (mode === '1') $('#ui_installment_controls').addClass('d-none'); else $('#ui_installment_controls').removeClass('d-none');

    originalScheduleConfig = { mode: mode, installments: installments, adjustmentType: adjustment, monthlyAmount: monthly, yearlyAdjustment: yearly, startDate: start_date, startOption: start_option, interestPercent: interest_percent };
  }

  /* Generation functions (unchanged behavior) */
  function generateSchedule(){ if (!currentPurchaseData){ alert('Purchase not loaded'); return; } var mode = $('#ui_mode').val(); if (mode === '1') generateFull(); else generateInstallments(); setUnsaved(true); }
  function generateFull(){
    var total = intval(currentPurchaseData.total_price); var booking = intval(currentPurchaseData.booking_money); var down = intval(currentPurchaseData.down_payment); var remaining = total - booking - down;
    var preserved = currentSchedule.filter(r => r.type==='booking' || r.type==='down');
    var start = parseDateInputToYMD($('#ui_start_date').val() || originalScheduleConfig.startDate || new Date().toISOString().slice(0,10));
    var full = { particular:'Full Payment', type:'installment', date:start, payment_date:'', payment_method:'', paid_amount:null, installment_amount: remaining, original_installment_amount: remaining, installment:'Full', money_receipt_no:'', total_dues:'', remarks:'', adjustment:false, manual_adjustment:false, manual_installment_edit:false, manual_remarks:false, history:[], paid:false, interest_amount_calc:0 };
    currentSchedule = preserved.concat([full]);
    recalcTotalDues(); renderScheduleTable(); updateTotals();
  }

  function generateInstallments(){
    var installments = parseInt($('#ui_installments').val() || originalScheduleConfig.installments || 60, 10);
    var adjustmentType = $('#ui_adjustment_type').val() || originalScheduleConfig.adjustmentType || 'year_end';
    var monthlyInput = intval($('#ui_monthly_amount').val() || originalScheduleConfig.monthlyAmount || 0);
    var yearlyAdjustment = intval($('#ui_yearly_adjustment').val() || originalScheduleConfig.yearlyAdjustment || 0);
    var startDate = parseDateInputToYMD($('#ui_start_date').val() || originalScheduleConfig.startDate || new Date().toISOString().slice(0,10));
    var startOption = $('#ui_start_option').val() || originalScheduleConfig.startOption || 'exact';

    var total = intval(currentPurchaseData.total_price); var booking = intval(currentPurchaseData.booking_money); var down = intval(currentPurchaseData.down_payment); var remaining = total - booking - down;

    var preserved = currentSchedule.filter(r => r.type==='booking' || r.type==='down'); if (preserved.length === 0) preserved = buildDefaultScheduleFromPurchase(currentPurchaseData);

    var years = Math.ceil(installments / 12); var adjMonths = []; var totalAdjSum = 0;
    if (yearlyAdjustment > 0 && adjustmentType !== 'custom'){
      if (adjustmentType === 'year_quarterly'){
        for (var y=0; y<years; y++){ [2,5,8,11].forEach(function(off){ var idx = y*12 + off; if (idx < installments){ adjMonths.push(idx); totalAdjSum += yearlyAdjustment; } }); }
      } else {
        for (var y=0; y<years; y++){ var idx = 0; if (adjustmentType === 'year_start') idx = y*12; else if (adjustmentType === 'year_middle') idx = y*12 + 6; else idx = y*12 + 11; if (idx < installments){ adjMonths.push(idx); totalAdjSum += yearlyAdjustment; } }
      }
    }

    var remainingAfterAdj = remaining - totalAdjSum; if (remainingAfterAdj < 0) remainingAfterAdj = 0;
    var regularCount = installments - adjMonths.length; if (regularCount < 0) regularCount = 0;
    var monthlyAmount = monthlyInput > 0 ? monthlyInput : (regularCount > 0 ? Math.floor(remainingAfterAdj / regularCount) : 0);

    var amounts = new Array(installments).fill(0);
    adjMonths.forEach(function(mi){ amounts[mi] = yearlyAdjustment; });
    for (var i=0;i<installments;i++){ if (amounts[i] === 0) amounts[i] = monthlyAmount; }

    var baseSum = amounts.reduce((s,v)=>s+v,0);
    var diff = remaining - baseSum;
    if (diff !== 0){
      var distributeIdxs = [];
      for (var k=0;k<installments;k++){ if (adjMonths.indexOf(k) === -1) distributeIdxs.push(k); }
      if (distributeIdxs.length === 0){ for (var k2=0;k2<installments;k2++) distributeIdxs.push(k2); }
      var sign = diff > 0 ? 1 : -1; var left = Math.abs(diff); var j = 0;
      while (left > 0){ var target = distributeIdxs[j % distributeIdxs.length]; amounts[target] += sign; left--; j++; }
    }

    var rows = [];
    var cd = parseYMD(startDate);
    if (!cd || isNaN(cd.getTime())) cd = new Date();
    if (startOption === 'start') cd.setDate(1);
    else if (startOption === 'middle') cd.setDate(15);
    else if (startOption === 'end') cd.setDate(new Date(cd.getFullYear(), cd.getMonth()+1, 0).getDate());

    for (var idx=0; idx<installments; idx++){
      var isAdj = adjMonths.indexOf(idx) !== -1;
      var amt = intval(amounts[idx]);
      var label = (idx===0 ? '1st Installment' : (idx+1)+'th Installment');
      rows.push({ particular: label, type: 'installment', date: cd.getFullYear() + '-' + ('0'+(cd.getMonth()+1)).slice(-2) + '-' + ('0'+cd.getDate()).slice(-2), payment_date: '', payment_method: '', paid_amount: null, installment_amount: amt, original_installment_amount: amt, installment: idx+1, money_receipt_no: '', total_dues: '', remarks: isAdj ? 'Yearly Adjustment' : '', adjustment: isAdj, manual_adjustment: false, manual_installment_edit: false, manual_remarks:false, history: [], paid: false, interest_amount_calc: 0 });
      cd.setMonth(cd.getMonth()+1);
    }

    currentSchedule = preserved.concat(rows);

    var sumAll = currentSchedule.reduce(function(s,r){ return s + intval(r.installment_amount); }, 0);
    var totalDiff = total - sumAll;
    if (totalDiff !== 0){ for (var rr=currentSchedule.length-1; rr>=0; rr--){ if (currentSchedule[rr].type === 'installment'){ currentSchedule[rr].installment_amount = intval(currentSchedule[rr].installment_amount) + totalDiff; if (!currentSchedule[rr].manual_installment_edit) currentSchedule[rr].original_installment_amount = currentSchedule[rr].installment_amount; break; } } }

    recalcTotalDues(); renderScheduleTable(); updateTotals();
  }

  /* Mark helpers */
  function markAllPaid(){
    currentSchedule.forEach(function(r){
      var old = r.paid_amount;
      r.paid_amount = intval(r.installment_amount || 0);
      if (!r.payment_date) r.payment_date = r.date || new Date().toISOString().slice(0,10);
      r.paid = true; r.manual_adjustment = true; r.manual_remarks = true;
      recordRowChange(currentSchedule.indexOf(r), 'paid_amount', old, r.paid_amount, 'Mark all paid');
      autoGenerateRemarkForRow(currentSchedule.indexOf(r));
    });
    recalcTotalDues(); renderScheduleTable(); updateTotals(); setUnsaved(true);
  }

  function markAllUnpaid(){
    currentSchedule.forEach(function(r){
      var old = r.paid_amount;
      r.paid_amount = null; r.payment_date = ''; r.paid = false; r.manual_adjustment = true; r.manual_remarks = false; r.remarks = '';
      recordRowChange(currentSchedule.indexOf(r), 'paid_amount', old, null, 'Mark all unpaid');
      autoGenerateRemarkForRow(currentSchedule.indexOf(r));
    });
    recalcTotalDues(); renderScheduleTable(); updateTotals(); setUnsaved(true);
  }

  /* Recalc totals & interest (updated rules) */
  function recalcTotalDues(){
    if (!currentPurchaseData) return;
    var total = intval(currentPurchaseData.total_price);
    var booking = intval(currentPurchaseData.booking_money);
    var down = intval(currentPurchaseData.down_payment);
    var baseRemaining = total - booking - down;

    var runningBefore = baseRemaining;
    var cumulativePaid = 0;
    var cumulativeOverdue = 0;
    var cumulativeOverpayment = 0;

    var totalInterestUptoToday = 0;
    var todayObj = todayStart();

    var globalPct = intval($('#ui_interest_percent').val() || (originalScheduleConfig && originalScheduleConfig.interestPercent) || intval(SCHEDULE_CONFIG.interest_default || 3));

    for (var i = 0; i < currentSchedule.length; i++){
      var row = currentSchedule[i];
      var inst = intval(row.installment_amount || 0);
      var paid = (row.paid_amount === null || row.paid_amount === undefined) ? 0 : intval(row.paid_amount || 0);

      var rowDateStr = (row.date || '').toString().slice(0,10);
      var rowPMDateStr = (row.payment_date || '').toString().slice(0,10);
      var dueDateObj = null;
      if (rowDateStr){ dueDateObj = parseYMD(rowDateStr); if (dueDateObj && isNaN(dueDateObj.getTime())) dueDateObj = null; }
      var paymentDateObj = null;
      if (rowPMDateStr){ paymentDateObj = parseYMD(rowPMDateStr); if (paymentDateObj && isNaN(paymentDateObj.getTime())) paymentDateObj = null; }

      // determine if this row is future and has no payment -> hide calculations for that row
      var isFutureNoPayment = false;
      if (dueDateObj && dueDateObj > todayObj && (row.paid_amount === null || intval(row.paid_amount || 0) === 0)){
        isFutureNoPayment = true;
      }

      // raw overdue / overpayment (per-row arithmetic using paid if present, treat null as 0)
      var rawRowOverDue = Math.max(inst - paid, 0);
      var rowOverPayment = Math.max(paid - inst, 0);

      // if future and no payment -> blank out those columns and skip accumulation
      if (isFutureNoPayment){
        row._future_no_payment = true;
        row.overdue_raw = 0;
        row.overdue = 0;
        row.overpayment = 0;
        row.interest_amount_calc = 0;
        row.interest_percent = 0;
        row.balance = '';
        row._remark_days_after_grace = null;
        // DO NOT add to cumulativeOverdue or cumulativeOverpayment
      } else {
        row._future_no_payment = false;
        // Add to cumulative totals only when due <= today OR the row has paid amount even if future
        var includeInCumulative = true;
        if (dueDateObj && dueDateObj > todayObj && (row.paid_amount === null || intval(row.paid_amount || 0) === 0)){
          includeInCumulative = false;
        }
        // accumulate
        if (includeInCumulative){
          cumulativeOverdue += rawRowOverDue;
          cumulativeOverpayment += rowOverPayment;
        }

        // interest logic: flat percent applied to raw overdue, but skip if paid percent >= threshold
        var interestCalc = 0;
        var appliedRate = 0;
        try {
          var actualRowOverDue = rawRowOverDue;
          var paidPct = inst === 0 ? 0 : (paid / inst * 100);
          var skipInterest = (paidPct >= PAID_THRESHOLD);

          if (actualRowOverDue > 0 && !skipInterest && globalPct > 0){
            appliedRate = globalPct;
            interestCalc = Math.floor((actualRowOverDue * appliedRate) / 100);
            totalInterestUptoToday += interestCalc;
          } else {
            appliedRate = 0; interestCalc = 0;
          }

          var anchorDate = paymentDateObj || dueDateObj;
          var daysAfterGrace = null;
          if (anchorDate){ var rawDays = daysBetween(anchorDate, todayObj); daysAfterGrace = Math.max(0, rawDays - GRACE_DAYS); }

          row._remark_days_after_grace = (daysAfterGrace !== null) ? daysAfterGrace : null;
        } catch(e){ interestCalc = 0; appliedRate = 0; row._remark_days_after_grace = null; }

        row.overdue_raw = rawRowOverDue;
        row.overdue = rawRowOverDue;
        row.overpayment = rowOverPayment;
        row.interest_amount_calc = interestCalc;
        row.interest_percent = appliedRate;

        // balance: runningBefore - paid (show numeric)
        row.balance = intval(runningBefore - paid) > 0 ? intval(runningBefore - paid) : 0;
      }

      var runningAfter = runningBefore - paid;
      cumulativePaid += paid;

      var dueNowValue = (row.paid_amount !== null && row.paid_amount !== undefined) ? (cumulativeOverdue - cumulativeOverpayment) : '-';

      row.running_total_before = runningBefore;
      row.running_total_after = runningAfter;
      row.cumulative_paid = cumulativePaid;
      row.cumulative_overdue = cumulativeOverdue;
      row.cumulative_overpayment = cumulativeOverpayment;
      row.due_now = dueNowValue;
      row.due_now_numeric = (dueNowValue === '-' ? 0 : dueNowValue);
      row.due_now_calc = (dueNowValue === '-') ? '' : intval(dueNowValue);

      row.over_due_type = rowOverPayment > 0 ? 'overpayment' : (row.overdue > 0 ? 'overdue' : 'clear');
      row.over_due_amount = rowOverPayment > 0 ? rowOverPayment : row.overdue;

      row.paid = (inst > 0 && paid >= inst);
      row.manual_adjustment = !!row.manual_adjustment;
      row.manual_installment_edit = !!row.manual_installment_edit;

      if (!row.manual_remarks){ autoGenerateRemarkForRow(i); }

      runningBefore = runningAfter;
    }

    window.scheduleColumnTotals = {
      sumOverdue: intval(cumulativeOverdue),
      sumOverpayment: intval(cumulativeOverpayment),
      cumulativePaidTotal: intval(cumulativePaid),
      remainingAfterAll: intval(Math.max(0, runningBefore)),
      totalInterestUptoToday: intval(totalInterestUptoToday)
    };

    // update UI totals
    $('#ui_total_overdue').text(formatIndianNumber(window.scheduleColumnTotals.sumOverdue));
    $('#ui_total_overpayment').text(formatIndianNumber(window.scheduleColumnTotals.sumOverpayment));
    $('#ui_total_overdue_footer').text(formatIndianNumber(window.scheduleColumnTotals.sumOverdue));
    $('#ui_total_overpayment_footer').text(formatIndianNumber(window.scheduleColumnTotals.sumOverpayment));
    $('#ui_paid_amount_footer').text(formatIndianNumber(window.scheduleColumnTotals.cumulativePaidTotal));
    $('#ui_remaining_footer').text(formatIndianNumber(window.scheduleColumnTotals.remainingAfterAll));
    $('#ui_total_interest').text(formatIndianNumber(window.scheduleColumnTotals.totalInterestUptoToday));

    return window.scheduleColumnTotals;
  }

  /* Render table */
  function renderScheduleTable(){
    var $tbody = $('#ui_schedule_table tbody'); $tbody.empty();
    var filter = $('input[name="schedule_status"]:checked').val();

    var indices = [];
    for (var i=0;i<currentSchedule.length;i++){
      var it = currentSchedule[i]; var include = true;
      if (filter === 'paid' && !(it.paid && intval(it.paid_amount) >= intval(it.installment_amount))) include = false;
      if (filter === 'unpaid' && (it.paid && intval(it.paid_amount) >= intval(it.installment_amount))) include = false;
      if (include) indices.push(i);
    }

    if (indices.length === 0){ $tbody.append('<tr><td colspan="15" class="text-center text-muted py-4"><i class="lni lni-calendar me-2"></i>No schedule items</td></tr>'); return; }

    indices.forEach(function(idx){
      var item = currentSchedule[idx];
      item.over_due_amount = intval(item.over_due_amount || item.overdue || 0);
      item.interest_amount_calc = intval(item.interest_amount_calc || 0);

      var particular = '<input data-idx="'+idx+'" data-field="particular" class="form-control form-control-sm schedule-input" type="text" value="'+escapeHtml(item.particular||'')+'">';
      var due = '<input data-idx="'+idx+'" data-field="date" class="form-control form-control-sm schedule-input date-input" type="text" placeholder="dd-mm-yyyy" value="'+(item.date? formatDateForInput(item.date) : '')+'">';
      var paydate = '<input data-idx="'+idx+'" data-field="payment_date" class="form-control form-control-sm schedule-input date-input" type="text" placeholder="dd-mm-yyyy" value="'+(item.payment_date? formatDateForInput(item.payment_date) : '')+'">';
      var pm = '<select data-idx="'+idx+'" data-field="payment_method" class="form-select form-select-sm schedule-input"><option value="">--</option><option value="Cash"'+(item.payment_method==='Cash'?' selected':'')+'>Cash</option><option value="Bank Transfer"'+(item.payment_method==='Bank Transfer'?' selected':'')+'>Bank Transfer</option><option value="NPSB"'+(item.payment_method==='NPSB'?' selected':'')+'>NPSB</option><option value="bKash"'+(item.payment_method==='bKash'?' selected':'')+'>bKash</option><option value="Other"'+(item.payment_method==='Other'?' selected':'')+'>Other</option></select>';

      // Installment (allow empty display when null)
      var instVal = (item.installment_amount !== null && item.installment_amount !== undefined) ? formatTkDisplay(item.installment_amount, true) : '';
      var installment_amount_input = '<input data-idx="'+idx+'" data-field="installment_amount" class="form-control form-control-sm schedule-input money-input text-end" type="text" value="'+instVal+'">';

      // Paid (allow empty)
      var paidVal = (item.paid_amount !== null && item.paid_amount !== undefined) ? formatTkDisplay(item.paid_amount, true) : '';
      var paid_amount_input = '<input data-idx="'+idx+'" data-field="paid_amount" class="form-control form-control-sm schedule-input money-input text-end" type="text" value="'+paidVal+'">';

      var balanceHtml = (item._future_no_payment ? '' : (item.balance === '' || item.balance === undefined ? '' : ('৳' + formatIndianNumber(item.balance))));
      var balanceCell = '<div class="text-end fw-medium balance-cell">'+ balanceHtml +'</div>';

      var overDueDisplay = (item._future_no_payment ? '' : (item.overdue > 0 ? ('৳' + formatIndianNumber(item.overdue)) : '-'));
      var overDueCell = '<div class="overdue-cell">'+(overDueDisplay)+'</div>';
      var overPaymentDisplay = (item._future_no_payment ? '' : (item.overpayment > 0 ? ('৳' + formatIndianNumber(item.overpayment)) : '-'));
      var overPaymentCell = '<div class="overpayment-cell">'+(overPaymentDisplay)+'</div>';
      var interestCell = '<div class="interest-cell">'+(item._future_no_payment ? '' : (item.interest_amount_calc ? ('৳' + formatIndianNumber(item.interest_amount_calc)) : '-'))+'</div>';

      var receipt = '<input data-idx="'+idx+'" data-field="money_receipt_no" class="form-control form-control-sm schedule-input" type="text" value="'+escapeHtml(item.money_receipt_no||'')+'">';
      var remarksVal = escapeHtml(item.remarks || '');
      var remarks = '<input data-idx="'+idx+'" data-field="remarks" class="form-control form-control-sm schedule-input" type="text" value="'+remarksVal+'">';
      var status = (item.paid && intval(item.paid_amount || 0) >= intval(item.installment_amount)) ? '<span class="badge bg-success">Paid</span>' : ( (item.paid_amount !== null && intval(item.paid_amount || 0) > 0) ? '<span class="badge bg-info">Partially Paid</span>' : '<span class="badge bg-warning">Unpaid</span>' );
      var lockBtn = '<button title="Toggle row installment edit" class="btn btn-sm btn-outline-secondary me-1 toggle-row-edit" data-idx="'+idx+'">'+(item.manual_installment_edit ? '<i class="lni lni-unlock"></i>' : '<i class="lni lni-lock"></i>')+'</button>';
      var action = lockBtn + '<button class="btn btn-sm btn-outline-secondary toggle-paid" data-idx="'+idx+'">' + (item.paid_amount !== null && intval(item.paid_amount) >= intval(item.installment_amount) ? 'Mark Unpaid' : 'Mark Paid') + '</button>';
      var rowClass = (item.paid_amount !== null && intval(item.paid_amount) >= intval(item.installment_amount)) ? 'schedule-highlight-paid' : (item.paid_amount !== null && intval(item.paid_amount) > 0 ? 'table-primary' : 'schedule-highlight-unpaid');

      var row = '<tr data-idx-row="'+idx+'" class="'+rowClass+'">' +
                '<td class="text-center align-middle">'+(idx+1)+'</td>' +
                '<td>'+particular+'</td>' +
                '<td>'+due+'</td>' +
                '<td>'+paydate+'</td>' +
                '<td>'+pm+'</td>' +
                '<td class="text-end installment-amount-cell">'+installment_amount_input+'</td>' +
                '<td class="text-end paid-amount-cell">'+paid_amount_input+'</td>' +
                '<td class="text-end balance-col">'+balanceCell+'</td>' +
                '<td class="text-end overdue-col">'+overDueCell+'</td>' +
                '<td class="text-end overpayment-col">'+overPaymentCell+'</td>' +
                '<td class="text-end interest-col">'+interestCell+'</td>' +
                '<td>'+receipt+'</td>' +
                '<td>'+remarks+'</td>' +
                '<td class="text-center align-middle status-col">'+status+'</td>' +
                '<td class="text-center align-middle action-col">'+action+'</td>' +
                '</tr>';
      $tbody.append(row);
    });

    if (!window.scheduleColumnTotals) recalcTotalDues();

    initializeRowDatePickers();
    bindTableEvents();
  }

  /* Date pickers */
  function initializeRowDatePickers(){
    $('#ui_schedule_table tbody .date-input').each(function(){
      var el = this;
      if (typeof flatpickr === 'function' && !el._flatpickr){
        try {
          flatpickr(el, {
            dateFormat: 'd-m-Y',
            allowInput: true,
            onChange: function(selectedDates, dateStr){
              var idx = parseInt($(el).attr('data-idx'),10);
              var field = $(el).attr('data-field');
              var ymd = parseDateInputToYMD(dateStr);
              if (!isNaN(idx) && typeof currentSchedule[idx] !== 'undefined'){
                currentSchedule[idx][field] = ymd;
                autoGenerateRemarkForRow(idx);
                recalcTotalDues(); updateRowsFrom(idx); updateTotals(); setUnsaved(true);
              }
            }
          });
        } catch(e){}
      }

      $(el).off('input.closePicker').on('input.closePicker', function(){
        if (el._flatpickr) try { el._flatpickr.close(); } catch(e){}
      });

      $(el).off('blur.normalize').on('blur.normalize', function(){
        var $el = $(this); var raw = $el.val();
        var parsed = parseDateInputToYMD(raw);
        var idx = parseInt($el.attr('data-idx'),10);
        var old = (currentSchedule[idx] && currentSchedule[idx].date) ? formatDateForInput(currentSchedule[idx].date) : '';
        if (parsed === '' && raw.trim() !== '') {
          alert('Invalid date format. Use dd-mm-yyyy, dd.mm.yyyy or dd/mm/yyyy.');
          $el.val(old);
          return;
        }
        var field = $el.attr('data-field');
        if (!isNaN(idx) && typeof currentSchedule[idx] !== 'undefined'){
          currentSchedule[idx][field] = parsed;
          $el.val(formatDateForInput(parsed));
          autoGenerateRemarkForRow(idx);
          recalcTotalDues(); updateRowsFrom(idx); updateTotals(); setUnsaved(true);
        }
      });
    });
  }

  /* Update single row display */
  function updateRowDisplay(idx){
    var $row = $('#ui_schedule_table tbody tr[data-idx-row="'+idx+'"]');
    if ($row.length === 0) return;
    var item = currentSchedule[idx];

    var $paidInput = $row.find('input[data-field="paid_amount"]');
    if ($paidInput.length){
      if (document.activeElement !== $paidInput[0]){
        $paidInput.val(item.paid_amount !== null && item.paid_amount !== undefined ? formatTkDisplay(item.paid_amount, true) : '');
      } else {
        // keep raw typed zeros by grouping from digits (if any)
        var rawDigits = (item.paid_amount === null || item.paid_amount === undefined) ? '' : String(item.paid_amount);
        if (rawDigits === '') $paidInput.val('');
        else $paidInput.val(formatTkDisplay(item.paid_amount, true));
      }
    }

    var $instInput = $row.find('input[data-field="installment_amount"]');
    if ($instInput.length){
      if (document.activeElement !== $instInput[0]){
        $instInput.val(item.installment_amount !== null && item.installment_amount !== undefined ? formatTkDisplay(item.installment_amount, true) : '');
      } else {
        var rawDigits2 = (item.installment_amount === null || item.installment_amount === undefined) ? '' : String(item.installment_amount);
        if (rawDigits2 === '') $instInput.val('');
        else $instInput.val(formatTkDisplay(item.installment_amount, true));
      }
      if (!installmentColumnEditable && !item.manual_installment_edit) $instInput.prop('readonly', true).addClass('readonly-input'); else $instInput.prop('readonly', false).removeClass('readonly-input');
    }

    $row.find('input[data-field="date"]').val(formatDateForInput(item.date) || '');
    $row.find('input[data-field="payment_date"]').val(formatDateForInput(item.payment_date) || '');
    $row.find('input[data-field="money_receipt_no"]').val(item.money_receipt_no || '');

    var $remarks = $row.find('input[data-field="remarks"]');
    if (!item.manual_remarks){ autoGenerateRemarkForRow(idx); $remarks.val(item.remarks || ''); } else { $remarks.val(item.remarks || ''); }

    var statusHtml = (item.paid && intval(item.paid_amount || 0) >= intval(item.installment_amount)) ? '<span class="badge bg-success">Paid</span>' : ( (item.paid_amount !== null && intval(item.paid_amount || 0) > 0) ? '<span class="badge bg-info">Partially Paid</span>' : '<span class="badge bg-warning">Unpaid</span>' );
    $row.find('.status-col').html(statusHtml);

    var balanceHtml = (item._future_no_payment ? '' : (item.balance === '' || item.balance === undefined) ? '' : ('৳' + formatIndianNumber(item.balance)));
    $row.find('.balance-col .balance-cell').html(balanceHtml ? ('<div class="text-end fw-medium">' + balanceHtml + '</div>') : '');

    if (item._future_no_payment){
      $row.find('.overdue-col .overdue-cell').html('');
      $row.find('.overpayment-col .overpayment-cell').html('');
      $row.find('.interest-col .interest-cell').html('');
      if (!item.manual_remarks) $row.find('input[data-field="remarks"]').val('');
    } else {
      $row.find('.overdue-col .overdue-cell').html(item.overdue>0 ? '<div class="fw-medium text-end text-danger">৳' + formatIndianNumber(item.overdue) + '</div>' : '<div class="text-end fw-medium text-muted">-</div>');
      $row.find('.overpayment-col .overpayment-cell').html(item.overpayment>0 ? '<div class="fw-medium text-end text-success">৳' + formatIndianNumber(item.overpayment) + '</div>' : '<div class="text-end fw-medium text-muted">-</div>');
      var interestHtml = item.interest_amount_calc ? ('<div class="fw-medium text-end text-danger">৳' + formatIndianNumber(item.interest_amount_calc) + '</div>') : '<div class="text-end text-muted">-</div>';
      $row.find('.interest-col .interest-cell').html(interestHtml);
    }

    var $togglePaid = $row.find('.toggle-paid');
    if ($togglePaid.length){
      var paidLabel = (item.paid_amount !== null && intval(item.paid_amount) >= intval(item.installment_amount) && intval(item.installment_amount) > 0) ? 'Mark Unpaid' : 'Mark Paid';
      $togglePaid.text(paidLabel);
    }
    var $toggleEdit = $row.find('.toggle-row-edit');
    if ($toggleEdit.length){ $toggleEdit.html(item.manual_installment_edit ? '<i class="lni lni-unlock"></i>' : '<i class="lni lni-lock"></i>'); }

    var rowClass = (item.paid_amount !== null && intval(item.paid_amount) >= intval(item.installment_amount)) ? 'schedule-highlight-paid' : (item.paid_amount !== null && intval(item.paid_amount) > 0 ? 'table-primary' : 'schedule-highlight-unpaid');
    $row.removeClass('schedule-highlight-paid schedule-highlight-unpaid table-primary').addClass(rowClass);
  }

  function updateRowsFrom(startIdx){
    if (startIdx < 0) startIdx = 0;
    for (var i = startIdx; i < currentSchedule.length; i++){ updateRowDisplay(i); }
    updateFooter();
  }

  function updateFooter(){
    $('#ui_total_amount').text(fmtMoneyInt(currentSchedule.reduce((s,r)=>s+intval(r.installment_amount),0)));
    var s = window.scheduleColumnTotals || { sumOverdue:0, sumOverpayment:0, cumulativePaidTotal:0, remainingAfterAll:0, totalInterestUptoToday:0 };
    $('#ui_total_overdue').text(formatIndianNumber(s.sumOverdue));
    $('#ui_total_overpayment').text(formatIndianNumber(s.sumOverpayment));
    $('#ui_total_overdue_footer').text(formatIndianNumber(s.sumOverdue));
    $('#ui_total_overpayment_footer').text(formatIndianNumber(s.sumOverpayment));
    $('#ui_total_interest').text(formatIndianNumber(s.totalInterestUptoToday));
    $('#ui_paid_amount_footer').text(formatIndianNumber(s.cumulativePaidTotal));
    $('#ui_remaining_footer').text(formatIndianNumber(s.remainingAfterAll));
  }

  /* Bind events */
  function bindTableEvents(){
    // money input: preserve typed zeros visually while editing; model stores numeric or null
    $('#ui_schedule_table tbody').off('input.money').on('input.money', '.money-input', function(e){
      var $el = $(this); var idx = parseInt($el.attr('data-idx'),10); var field = $el.attr('data-field'); if (typeof currentSchedule[idx] === 'undefined') return;

      var selStart = this.selectionStart || this.value.length;
      var left = $el.val().slice(0, selStart);
      var digitsBefore = (left.match(/\d/g) || []).length;

      var rawDigits = digitsOnly($el.val());
      var numeric = (rawDigits === '') ? null : parseInt(rawDigits, 10);

      if (field === 'installment_amount'){ if (!installmentColumnEditable && !currentSchedule[idx].manual_installment_edit){ updateRowDisplay(idx); return; } }

      var oldVal = currentSchedule[idx][field];
      var newModelVal = (numeric === null) ? null : numeric;
      if (oldVal !== newModelVal){ recordRowChange(idx, field, oldVal, newModelVal, 'User typed money input'); currentSchedule[idx][field] = newModelVal; if (field === 'paid_amount' || field === 'installment_amount'){ currentSchedule[idx].manual_adjustment = true; if (field === 'installment_amount') currentSchedule[idx].manual_installment_edit = currentSchedule[idx].manual_installment_edit || false; } }

      // Format display preserving typed zeros:
      var formatted = '';
      if (rawDigits === '') {
        formatted = '';
      } else {
        var grouped = groupIndianFromDigits(rawDigits);
        formatted = '৳' + grouped;
      }
      $el.val(formatted);
      setCaretPositionToDigits($el, digitsBefore, formatted);

      // update paid flags
      if (field === 'paid_amount'){
        var instAmt = intval(currentSchedule[idx].installment_amount || 0);
        var paidAmt = (currentSchedule[idx].paid_amount === null || currentSchedule[idx].paid_amount === undefined) ? 0 : intval(currentSchedule[idx].paid_amount || 0);
        if (instAmt > 0 && paidAmt >= instAmt){ currentSchedule[idx].paid = true; if (!currentSchedule[idx].payment_date) currentSchedule[idx].payment_date = currentSchedule[idx].date || new Date().toISOString().slice(0,10); currentSchedule[idx].manual_remarks = true; }
        else if (currentSchedule[idx].paid_amount === null){ currentSchedule[idx].paid = false; currentSchedule[idx].manual_remarks = false; currentSchedule[idx].remarks = ''; autoGenerateRemarkForRow(idx); }
        else { currentSchedule[idx].paid = false; if (!currentSchedule[idx].payment_date) currentSchedule[idx].payment_date = currentSchedule[idx].date || new Date().toISOString().slice(0,10); currentSchedule[idx].manual_remarks = true; }
      }

      if (field === 'installment_amount'){
        var inst = (currentSchedule[idx].installment_amount === null) ? 0 : intval(currentSchedule[idx].installment_amount || 0);
        var paidAmt2 = (currentSchedule[idx].paid_amount === null) ? 0 : intval(currentSchedule[idx].paid_amount || 0);
        currentSchedule[idx].paid = (inst > 0 && paidAmt2 >= inst);
        if (!currentSchedule[idx].original_installment_amount) currentSchedule[idx].original_installment_amount = inst;
      }

      if (!currentSchedule[idx].manual_remarks) autoGenerateRemarkForRow(idx);

      recalcTotalDues(); updateRowsFrom(idx); updateTotals(); setUnsaved(true);
    });

    // non-money inputs
    $('#ui_schedule_table tbody').off('change.other').on('change.other', '.schedule-input:not(.money-input)', function(e){
      var $el = $(this); var idx = parseInt($el.attr('data-idx'),10); var field = $el.attr('data-field'); if (typeof currentSchedule[idx] === 'undefined') return;
      var rawVal = $el.val(); var val = rawVal; var old = currentSchedule[idx][field];

      if (field === 'date' || field === 'payment_date'){
        var parsed = parseDateInputToYMD(rawVal);
        if (parsed === '' && rawVal.trim() !== ''){
          alert('Invalid date format. Use dd-mm-yyyy (or dd.mm.yyyy / dd/mm/yyyy).');
          $el.val(formatDateForInput(old || ''));
          return;
        }
        val = parsed;
        $el.val(formatDateForInput(val));
      }

      if (old !== val){ recordRowChange(idx, field, old, val, 'User edited field'); currentSchedule[idx][field] = val; if (field === 'remarks') currentSchedule[idx].manual_remarks = true; }

      if (!currentSchedule[idx].manual_remarks) autoGenerateRemarkForRow(idx);

      recalcTotalDues(); updateRowsFrom(idx); updateTotals(); setUnsaved(true);
    });

    // toggle paid/unpaid
    $('#ui_schedule_table tbody').off('click.togglePaid').on('click.togglePaid', '.toggle-paid', function(){
      var idx = parseInt($(this).attr('data-idx'),10); if (typeof currentSchedule[idx] === 'undefined') return;
      var row = currentSchedule[idx];
      if (row.paid_amount !== null && intval(row.paid_amount) >= intval(row.installment_amount) && intval(row.installment_amount)>0){
        recordRowChange(idx, 'paid_amount', row.paid_amount, null, 'Mark Unpaid');
        row.paid_amount = null; row.payment_date = ''; row.paid = false; row.manual_adjustment = true; row.manual_remarks = false; row.remarks = '';
        autoGenerateRemarkForRow(idx);
      } else {
        recordRowChange(idx, 'paid_amount', row.paid_amount, intval(row.installment_amount || 0), 'Mark Paid');
        row.paid_amount = intval(row.installment_amount || 0);
        if (!row.payment_date) row.payment_date = row.date || new Date().toISOString().slice(0,10);
        row.paid = row.paid_amount>0; row.manual_adjustment = true; row.manual_remarks = true;
        autoGenerateRemarkForRow(idx);
      }
      recalcTotalDues(); updateRowsFrom(idx); updateTotals(); setUnsaved(true);
    });

    // toggle row installment edit
    $('#ui_schedule_table tbody').off('click.toggleRowEdit').on('click.toggleRowEdit', '.toggle-row-edit', function(){
      var idx = parseInt($(this).attr('data-idx'),10); toggleRowInstallmentEditable(idx); updateRowDisplay(idx);
    });

    $('#ui_schedule_table tbody input[data-field="installment_amount"]').each(function(){
      var $this = $(this); var idx = parseInt($this.attr('data-idx'),10); var item = currentSchedule[idx];
      if (!installmentColumnEditable && !item.manual_installment_edit) $this.prop('readonly', true).addClass('readonly-input'); else $this.prop('readonly', false).removeClass('readonly-input');
    });

    $('#ui_schedule_table tbody').off('input.remarks').on('input.remarks', 'input[data-field="remarks"]', function(){
      var idx = parseInt($(this).attr('data-idx'),10);
      if (isNaN(idx) || typeof currentSchedule[idx] === 'undefined') return;
      currentSchedule[idx].manual_remarks = true;
      currentSchedule[idx].remarks = $(this).val();
      recordRowChange(idx, 'remarks', null, currentSchedule[idx].remarks, 'User edited remarks');
      setUnsaved(true);
    });
  }

  function updateTotals(){ var totalInstallments = currentSchedule.reduce((s,r)=>s+intval(r.installment_amount),0); var paidAmount = currentSchedule.reduce((s,r)=>s + (r.paid_amount === null || r.paid_amount === undefined ? 0 : intval(r.paid_amount)),0); $('#ui_schedule_total').text(fmtMoneyInt(totalInstallments)); $('#ui_paid_amount').text(fmtMoneyInt(paidAmount)); $('#ui_total_amount').text(fmtMoneyInt(totalInstallments)); }

  /* Save */
  function saveSchedule(){
    var purchaseId = $('#ui_purchase_id').val(); if (!purchaseId){ alert('Purchase ID missing'); return; }
    recalcTotalDues();

    var total = intval(currentPurchaseData.total_price);
    var booking = intval(currentPurchaseData.booking_money);
    var down = intval(currentPurchaseData.down_payment);
    var expectedRemaining = total - booking - down;

    var installmentSum = 0;
    currentSchedule.forEach(function(r){ var p = (r.particular || '').toLowerCase(); var isBooking = (r.type === 'booking') || (p.indexOf('booking') !== -1 && p.indexOf('down') === -1); var isDown = (r.type === 'down') || (p.indexOf('down') !== -1); if (!isBooking && !isDown) installmentSum += intval(r.installment_amount); });

    if (Math.abs(installmentSum - expectedRemaining) > 0){ var proceed = confirm('Installments total (৳'+fmtMoneyInt(installmentSum)+') does not match expected remaining (৳'+fmtMoneyInt(expectedRemaining)+'). The server will auto-adjust the last installment row if possible. Continue and save anyway?'); if (!proceed) return; }

    var $btn = $('#ui_save_schedule'); $btn.prop('disabled', true).html('<i class="spinner-border spinner-border-sm me-1"></i>Saving...');

    var payloadRows = currentSchedule.map(function(r,idx){
      var instAmt = intval(r.installment_amount || 0);
      var paidAmt = (r.paid_amount === null || r.paid_amount === undefined) ? 0 : intval(r.paid_amount || 0);
      var paidFlag = (instAmt > 0 && paidAmt >= instAmt) ? true : false;

      return {
        index: idx,
        particular: (r.particular || '').toString(),
        type: (r.type || '').toString(),
        date: (r.date || '').toString(),
        payment_date: (r.payment_date || '').toString(),
        payment_method: (r.payment_method || '').toString(),

        installment_amount: instAmt,
        original_installment_amount: (r.original_installment_amount !== undefined ? intval(r.original_installment_amount) : instAmt),
        amount: instAmt,
        paid_amount: paidAmt,
        installment: r.installment || '',
        money_receipt_no: (r.money_receipt_no || '').toString(),

        cumulative_overdue: r.cumulative_overdue ? intval(r.cumulative_overdue) : 0,
        cumulative_overpayment: r.cumulative_overpayment ? intval(r.cumulative_overpayment) : 0,
        cumulative_paid: r.cumulative_paid ? intval(r.cumulative_paid) : 0,
        due_now: (r.due_now === '' || r.due_now === undefined) ? '' : (r.due_now === '-' ? '-' : intval(r.due_now)),

        over_due_type: (r.over_due_type || 'clear'),
        over_due_amount: intval(r.over_due_amount || 0),

        remarks: (r.remarks || '').toString(),
        adjustment: !!r.adjustment,
        manual_adjustment: !!r.manual_adjustment,
        manual_installment_edit: !!r.manual_installment_edit,
        history: (r.history && Array.isArray(r.history)) ? r.history : [],
        paid: paidFlag,

        interest_percent: intval(r.interest_percent || $('#ui_interest_percent').val() || 0),
        interest_amount_calc: intval(r.interest_amount_calc || 0)
      };
    });

    var payload = { purchase_id: purchaseId, schedule: JSON.stringify(payloadRows), totals: JSON.stringify(window.scheduleColumnTotals || {}) };

    $.post(Wo_Ajax_Requests_File() + '?f=manage_inventory&s=update_installment', payload)
      .done(function(resp){ var data = (typeof resp === 'string') ? (function(){ try { return JSON.parse(resp);} catch(e){ return resp;} })() : resp; if (data && data.status === 200){ alert('Schedule saved successfully'); setUnsaved(false); $('#updateInstallmentModal').modal('hide'); if (typeof DataTableRefresh === 'function') DataTableRefresh(); } else { alert('Failed to save: ' + (data && data.message ? data.message : 'Unknown error')); } })
      .fail(function(){ alert('Server error while saving schedule'); })
      .always(function(){ $btn.prop('disabled', false).html('<i class="lni lni-save me-1"></i>Save Schedule'); });
  }

  /* Preview */
  function previewXlsx(){ var purchaseId = $('#ui_purchase_id').val(); if (!purchaseId){ alert('Purchase ID missing'); return; } var $btn = $('#ui_preview_xlsx'); $btn.prop('disabled', true).html('<i class="spinner-border spinner-border-sm me-1"></i>Preparing...'); var payloadRows = currentSchedule.map(function(r){ var instAmt = intval(r.installment_amount || 0); var paidAmt = (r.paid_amount === null || r.paid_amount === undefined) ? 0 : intval(r.paid_amount || 0); return { particular: (r.particular || '').toString(), type: (r.type || '').toString(), date: (r.date || '').toString(), payment_date: (r.payment_date || '').toString(), payment_method: (r.payment_method || '').toString(), installment_amount: instAmt, amount: instAmt, original_installment_amount: r.original_installment_amount ? intval(r.original_installment_amount) : instAmt, paid_amount: paidAmt, installment: r.installment || '', money_receipt_no: (r.money_receipt_no || '').toString(), total_dues: (r.total_dues || '').toString(), remarks: (r.remarks || '').toString(), adjustment: !!r.adjustment, manual_adjustment: !!r.manual_adjustment, paid: (instAmt>0 && paidAmt >= instAmt) }; }); $.post(Wo_Ajax_Requests_File() + '?f=manage_inventory&s=installment_excel_modal', { purchase_id: purchaseId, schedule: JSON.stringify(payloadRows) }) .done(function(resp){ var data = typeof resp === 'string' ? (function(){ try { return JSON.parse(resp);} catch(e){ return resp;} })() : resp; if (data && data.status === 200) { $('body').append(data.html); $('#installmentExcelModal').modal('show'); } else { alert('Failed to open modal'); } }) .fail(function(){ alert('Server error while preparing preview'); }) .always(function(){ $btn.prop('disabled', false).html('<i class="lni lni-eye me-1"></i>Preview XLSX'); }); }

  /* Boot */
  if (typeof window.initViewClientComponents !== 'function'){ window.initViewClientComponents = function(){ initUpdateInstallment(); }; } else { var origInit = window.initViewClientComponents; window.initViewClientComponents = function(){ origInit(); initUpdateInstallment(); }; }
  $(function(){ if (typeof initUpdateInstallment === 'function') initUpdateInstallment(); });

});
</script>
